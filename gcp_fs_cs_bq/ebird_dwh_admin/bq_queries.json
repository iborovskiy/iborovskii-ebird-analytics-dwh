{
    "get_hwm": "\n    SELECT CAST(current_high_ts AS DATETIME)\n    FROM `fiery-rarity-396614.ds_ebird_dwh.high_water_mark`\n    WHERE table_id = '{}'\n",
    "log_insert": "\n    INSERT INTO `fiery-rarity-396614.ds_ebird_dwh.etl_log` (ts, event_type, event_description) VALUES ('{}', {}, '{}')\n",

    "get_weather_sql": "\n    SELECT DISTINCT o.locid, l.lat, l.lon, CAST(o.obsdt AS DATE) obsdt\n    FROM `fiery-rarity-396614.ds_ebird_dwh.dwh_fact_observation` o\n    JOIN `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_location` l\n    ON o.locid = l.locid\n    WHERE o.tavg IS NULL\n    ORDER BY o.locid, obsdt\n",

    "dwh_load_hotspots_dict_bq_sql": "\n    LOAD DATA INTO `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_dim_location_details_tmp`\n    (locid STRING, locname STRING, countryname STRING, subregionname STRING,\n    lat FLOAT64, lon FLOAT64, numspeciesalltime INTEGER, latestobsdt DATETIME)\n    OPTIONS(\n        expiration_timestamp="{}"\n    )\n    FROM FILES(\n        FORMAT=\'CSV\',\n        uris = [\'gs://fiery-rarity-396614-ebird/stg_hotspots.csv\'],\n        skip_leading_rows=1\n    );\n",
    "dwh_load_taxonomy_dict_bq_sql": "\n    LOAD DATA INTO `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_dim_species_details_tmp`\n    (speciesCode STRING, sciName STRING, comName STRING, category STRING, orderSciName STRING,\n    orderComName STRING, familyCode STRING, familyComName STRING, familySciName STRING)\n    OPTIONS(\n        expiration_timestamp="{}"\n    )\n    FROM FILES(\n        FORMAT=\'CSV\',\n        uris = [\'gs://fiery-rarity-396614-ebird/stg_taxonomy.csv\'],\n        skip_leading_rows=1\n    );\n",

    "dwh_load_checklist_dict_bq_sql": "\n    LOAD DATA INTO `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_dim_checklist_tmp`\n    (locid STRING, subid STRING, userdisplayname STRING,\n     numspecies INTEGER, obsfulldt DATETIME)\n    OPTIONS(\n        expiration_timestamp="{}"\n    )\n    FROM FILES(\n        FORMAT=\'CSV\',\n        uris = [\'gs://fiery-rarity-396614-ebird/stg_checklist.csv\'],\n        skip_leading_rows=1\n    );\n",
    "dwh_load_location_dict_bq_sql": "\n    LOAD DATA INTO `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_dim_location_tmp`\n    (locid STRING, locname STRING, lat FLOAT64, lon FLOAT64, countryname STRING,\n     subregionname STRING, latestobsdt DATETIME, numspeciesalltime INTEGER)\n    OPTIONS(\n        expiration_timestamp="{}"\n    )\n    FROM FILES(\n        FORMAT=\'CSV\',\n        uris = [\'gs://fiery-rarity-396614-ebird/stg_location.csv\'],\n        skip_leading_rows=1\n    );\n",
    "dwh_load_observation_bq_sql": "\n    LOAD DATA INTO `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_fact_observation_tmp`\n    (speciescode STRING, obsdt DATETIME, subid STRING,\n     obsid STRING, howmany INTEGER)\n    OPTIONS(\n        expiration_timestamp="{}"\n    )\n    FROM FILES(\n        FORMAT=\'CSV\',\n        uris = [\'gs://fiery-rarity-396614-ebird/stg_observation.csv\'],\n        skip_leading_rows=1\n    );\n",
    "dwh_load_weather_bq_sql": "\n    LOAD DATA INTO `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_fact_weather_observations_tmp`\n    (loc_id STRING, obsdt DATETIME, tavg FLOAT64, tmin FLOAT64, tmax FLOAT64, prcp FLOAT64,\n     snow FLOAT64, wdir FLOAT64, wspd FLOAT64, wpgt FLOAT64, pres FLOAT64, tsun FLOAT64,\n     update_ts DATETIME)\n    OPTIONS(\n        expiration_timestamp="{}"\n    )\n    FROM FILES(\n        FORMAT=\'CSV\',\n        uris = [\'gs://fiery-rarity-396614-ebird/stg_weather.csv\'],\n        skip_leading_rows=1\n    );\n",

    "dwh_update_bq_sql": "\n    BEGIN TRANSACTION;\n\n    MERGE `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_location_details` T\n    USING `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_dim_location_details_tmp` S\n    ON T.locid = S.locid\n    WHEN MATCHED THEN\n        UPDATE SET locname = S.locname, countryname = S.countryname,\n                    subregionname = S.subregionname, lat = S.lat, lon = S.lon,\n                    numspeciesalltime = S.numspeciesalltime, latestobsdt = S.latestobsdt\n    WHEN NOT MATCHED THEN\n        INSERT (locid, locname, countryname, subregionname, lat, lon, \n                numspeciesalltime, latestobsdt)\n        VALUES(locid, locname, countryname, subregionname, lat, lon, \n                numspeciesalltime, latestobsdt);\n\n    MERGE `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_species_details` T\n    USING `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_dim_species_details_tmp` S\n    ON T.speciescode = S.speciescode\n    WHEN MATCHED THEN\n        UPDATE SET sciname = S.sciname, comname = S.comname, category = S.category,\n                    ordersciname = S.ordersciname, ordercomname = S.ordercomname,\n                    familycode = S.familycode, familycomname = S.familycomname,\n                    familysciname = S.familysciname\n    WHEN NOT MATCHED THEN\n        INSERT (speciescode, sciname, comname, category, ordersciname, ordercomname, \n                familycode, familycomname, familysciname)\n        VALUES(speciescode, sciname, comname, category, ordersciname, ordercomname, \n                familycode, familycomname, familysciname); \n\n    MERGE `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_dt` T\n    USING (\n        SELECT DISTINCT obsdt, extract(day from obsdt) day, extract(month from obsdt) month,\n                FORMAT_DATETIME("%B",obsdt) month_name, extract(year from obsdt) year, \n                extract(quarter from obsdt) quarter\n        FROM `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_fact_observation_tmp`\n    ) S\n    ON T.obsdt = S.obsdt\n    WHEN NOT MATCHED THEN\n        INSERT (obsdt, day, month, month_name, year, quarter)\n        VALUES (obsdt, day, month, month_name, year, quarter);\n\n    MERGE `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_location` T\n    USING (\n        SELECT DISTINCT l.locid locid, l.locname locname, l.lat lat, l.lon lon,\n                    l.countryname countryname, l.subregionname subregionname,\n                    l.latestobsdt latestobsdt, d.numspeciesalltime numspeciesalltime\n        FROM `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_dim_location_tmp` l\n        LEFT JOIN `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_location_details` d\n        ON l.locid = d.locid\n    ) S\n    ON T.locid = S.locid\n    WHEN MATCHED THEN\n        UPDATE SET locname = S.locname, lat = S.lat, lon = S.lon,\n                    countryname = S.countryname, subregionname = S.subregionname,\n                    latestobsdt = S.latestobsdt, numspeciesalltime = S.numspeciesalltime\n    WHEN NOT MATCHED THEN\n        INSERT (locid, locname, lat, lon, countryname, subregionname, \n                latestobsdt, numspeciesalltime)\n        VALUES (locid, locname, lat, lon, countryname, subregionname, \n                latestobsdt, numspeciesalltime);\n\n    MERGE `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_checklist` T\n    USING `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_dim_checklist_tmp` S\n    ON T.subid = S.subid\n    WHEN MATCHED THEN\n        UPDATE SET locid = S.locid, userdisplayname = S.userdisplayname,\n                    numspecies = S.numspecies, obsfulldt = S.obsfulldt\n    WHEN NOT MATCHED THEN\n        INSERT (locid, subid, userdisplayname, numspecies, obsfulldt)\n        VALUES (locid, subid, userdisplayname, numspecies, obsfulldt);\n\n    MERGE `fiery-rarity-396614.ds_ebird_dwh.dwh_fact_observation` T\n    USING (\n        SELECT o.subid subid, o.speciescode speciescode, c.locId locId, \n                o.obsdt obsdt, o.howmany howmany\n        FROM `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_fact_observation_tmp` o\n        LEFT JOIN `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_checklist` c\n        ON o.subid = c.subid\n    ) S\n    ON T.subId = S.subId AND T.speciescode = S.speciescode\n    WHEN MATCHED THEN\n        UPDATE SET locid = S.locid, obsdt = S.obsdt, howmany = S.howmany\n    WHEN NOT MATCHED THEN\n        INSERT (subId, speciescode, locid, obsdt, howmany)\n        VALUES (subId, speciescode, locid, obsdt, howmany);\n\n    UPDATE `fiery-rarity-396614.ds_ebird_dwh.dwh_fact_observation` o\n    SET tavg = w.tavg, tmin = w.tmin, tmax = w.tmax, prcp = w.prcp,\n        snow = w.snow, wdir = w.wdir, wspd = w.wspd, wpgt = w.wpgt, \n        pres = w.pres, tsun = w.tsun\n    FROM `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_fact_weather_observations_tmp` w\n    WHERE o.locid = w.loc_id AND CAST(o.obsdt AS DATE) = w.obsdt;\n\n    MERGE `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_species` T\n    USING (\n        SELECT DISTINCT o.speciescode speciescode, d.sciName sciName, d.comName comName,\n                        d.category category, d.orderSciName orderSciName,\n                        d.orderComName orderComName, d.familyCode familyCode,\n                        d.familyComName familyComName, d.familySciName familySciName\n        FROM `fiery-rarity-396614.ds_ebird_dwh.dwh_fact_observation` o\n        LEFT JOIN `fiery-rarity-396614.ds_ebird_dwh.dwh_dim_species_details` d\n        ON o.speciescode = d.speciescode\n    ) S\n    ON T.speciescode = S.speciescode\n    WHEN MATCHED THEN\n        UPDATE SET sciName = S.sciName, comName = S.comName, category = S.category,\n                    orderSciName = S.orderSciName, orderComName = S.orderComName,\n                    familyCode = S.familyCode, familyComName = S.familyComName,\n                    familySciName = S.familySciName\n    WHEN NOT MATCHED THEN\n        INSERT (speciescode, sciName, comName, category, orderSciName, orderComName,\n                familyCode, familyComName, familySciName)\n        VALUES (speciescode, sciName, comName, category, orderSciName, orderComName,\n                familyCode, familyComName, familySciName);\n\n    UPDATE `fiery-rarity-396614.ds_ebird_dwh.high_water_mark`\n    SET current_high_ts = (SELECT MAX(obsdt)\n                           FROM `fiery-rarity-396614.ds_ebird_dwh.dwh_fact_observation`)\n    WHERE table_id = \'dwh_fact_observation\' AND\n            (SELECT MAX(obsdt)\n             FROM `fiery-rarity-396614.ds_ebird_dwh.dwh_fact_observation`) IS NOT NULL;\n\n    UPDATE `fiery-rarity-396614.ds_ebird_dwh.high_water_mark`\n    SET current_high_ts = (SELECT MAX(update_ts)\n                           FROM `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_fact_weather_observations_tmp`)\n    WHERE table_id = \'mrr_fact_weather_observations\' AND\n            (SELECT MAX(update_ts)\n             FROM `fiery-rarity-396614.ds_ebird_dwh_tmp.dwh_fact_weather_observations_tmp`) IS NOT NULL;\n                \n    COMMIT TRANSACTION;\n",
    "dwh_update_model_proc": "\n    CALL ds_ebird_dwh.dwh_process_observations("{0}");\n",
}